<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Puzzle Plaza de la Virgen - Mejorado</title>
<style>
  html, body {
    margin: 0; padding: 0; height: 100%;
    background: #f0f0f0;
    font-family: sans-serif;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    -webkit-tap-highlight-color: transparent; /* quitar el highlight en mÃ³vil */
  }
  h1 {
    margin: 16px;
    text-align: center;
  }
  #puzzleWrapper {
    width: 90vw;
    max-width: 1000px;
    aspect-ratio: 3 / 2;
    background: #ddd;
    position: relative;
    border: 5px solid #333;
    overflow: hidden;
    touch-action: none;
  }
  canvas {
    width: 100%;
    height: 100%;
    display: block;
    user-select: none;
  }
  #completeMsg {
    display: none;
    position: absolute;
    top: 40%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(255, 255, 255, 0.95);
    padding: 20px;
    border: 2px solid #333;
    border-radius: 12px;
    text-align: center;
    z-index: 10;
    font-size: 1.2em;
    user-select: none;
  }
  #continueBtn, #restartBtn {
    display: inline-block;
    margin: 12px 6px 0 6px;
    padding: 10px 20px;
    background: white;
    color: black;
    border: 2px solid black;
    border-radius: 10px;
    font-size: 1em;
    cursor: pointer;
    user-select: none;
  }
  #restartBtn {
    position: fixed;
    bottom: 16px;
    right: 16px;
    background: #333;
    color: white;
    border-color: #555;
    z-index: 20;
    box-shadow: 0 0 6px rgba(0,0,0,0.3);
  }
  #restartBtn:hover, #continueBtn:hover {
    background: black;
    color: white;
  }
  @media (orientation: landscape) {
    #puzzleWrapper {
      aspect-ratio: auto;
      width: 95vw;
      height: 60vh;
      max-height: 600px;
    }
  }
</style>
</head>
<body>
  <h1>Puzzle Plaza de la Virgen</h1>
  <div id="puzzleWrapper" role="main" aria-label="Puzzle interactivo">
    <canvas id="puzzleCanvas" tabindex="0" aria-describedby="instructions"></canvas>
    <div id="completeMsg" role="alert" aria-live="assertive">
      <strong>ðŸŽ‰ Puzzle completado</strong><br />
      <button id="continueBtn">Continuar</button>
    </div>
  </div>
  <button id="restartBtn" aria-label="Reiniciar puzzle">Reiniciar</button>

  <audio id="soundPlace" src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg" preload="auto"></audio>
  <audio id="soundComplete" src="https://actions.google.com/sounds/v1/cartoon/clang.ogg" preload="auto"></audio>

<script>
  (() => {
    const canvas = document.getElementById("puzzleCanvas");
    const ctx = canvas.getContext("2d");
    // Cambia aquÃ­ la URL de la imagen al host pÃºblico que uses:
    const imageSrc = "https://i.ibb.co/SXqwg32T/plaza-de-la-virgen-apaisada.jpg";
    const rows = 3;
    const cols = 4;
    let pieces = [];
    let draggingPiece = null;
    let offsetX = 0;
    let offsetY = 0;
    let img = new Image();
    let placedCount = 0;
    const completeMsg = document.getElementById("completeMsg");
    const continueBtn = document.getElementById("continueBtn");
    const restartBtn = document.getElementById("restartBtn");
    const soundPlace = document.getElementById("soundPlace");
    const soundComplete = document.getElementById("soundComplete");
    let animationFrameId = null;

    img.crossOrigin = "anonymous"; // para evitar problemas CORS en canvas
    img.onload = () => init();
    img.src = imageSrc;

    window.addEventListener("resize", () => {
      cancelAnimationFrame(animationFrameId);
      init();
    });

    function init() {
      const wrapper = document.getElementById("puzzleWrapper");
      const w = wrapper.clientWidth;
      const h = wrapper.clientHeight;
      canvas.width = w * devicePixelRatio;
      canvas.height = h * devicePixelRatio;
      canvas.style.width = w + "px";
      canvas.style.height = h + "px";
      ctx.setTransform(1,0,0,1,0,0);
      ctx.scale(devicePixelRatio, devicePixelRatio);

      const pw = w / cols;
      const ph = h / rows;
      pieces = [];
      placedCount = 0;
      completeMsg.style.display = "none";
      wrapper.style.borderColor = "#333";

      for (let r = 0; r < rows; r++) {
        for (let c = 0; c < cols; c++) {
          const piece = {
            sx: c * img.width / cols,
            sy: r * img.height / rows,
            sw: img.width / cols,
            sh: img.height / rows,
            x: Math.random() * (w - pw),
            y: Math.random() * (h - ph),
            w: pw,
            h: ph,
            correctX: c * pw,
            correctY: r * ph,
            placed: false
          };
          pieces.push(piece);
        }
      }
      draw();
    }

    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      // Dibujar piezas colocadas al fondo (para que no tapen)
      for (const p of pieces.filter(p => p.placed)) {
        drawPiece(p);
      }
      // Dibujar piezas sin colocar encima
      for (const p of pieces.filter(p => !p.placed)) {
        drawPiece(p);
      }
    }

    function drawPiece(p) {
      ctx.save();
      ctx.beginPath();
      ctx.rect(p.x, p.y, p.w, p.h);
      ctx.clip();
      ctx.drawImage(img, p.sx, p.sy, p.sw, p.sh, p.x, p.y, p.w, p.h);
      ctx.restore();
      ctx.strokeStyle = "#333";
      ctx.lineWidth = 1;
      ctx.strokeRect(p.x + 0.5, p.y + 0.5, p.w, p.h);
    }

    function getPointer(e) {
      const rect = canvas.getBoundingClientRect();
      const x = (e.clientX - rect.left);
      const y = (e.clientY - rect.top);
      return { x, y };
    }

    // Para que no se salga fuera del borde
    function clamp(value, min, max) {
      return Math.min(Math.max(value, min), max);
    }

    function startDrag(e) {
      const { x, y } = getPointer(e);
      // Recorrer piezas de arriba a abajo para detectar la que estÃ¡ encima
      for (let i = pieces.length - 1; i >= 0; i--) {
        const p = pieces[i];
        if (!p.placed && x >= p.x && x <= p.x + p.w && y >= p.y && y <= p.y + p.h) {
          draggingPiece = p;
          offsetX = x - p.x;
          offsetY = y - p.y;
          // Mover pieza seleccionada al final para dibujar encima
          pieces.splice(i, 1);
          pieces.push(draggingPiece);
          break;
        }
      }
    }

    function onDrag(e) {
      if (!draggingPiece) return;
      const { x, y } = getPointer(e);
      draggingPiece.x = clamp(x - offsetX, 0, canvas.width / devicePixelRatio - draggingPiece.w);
      draggingPiece.y = clamp(y - offsetY, 0, canvas.height / devicePixelRatio - draggingPiece.h);
      draw();
    }

    function stopDrag() {
      if (!draggingPiece) return;
      const snap = draggingPiece.w / 4;
      const dx = Math.abs(draggingPiece.x - draggingPiece.correctX);
      const dy = Math.abs(draggingPiece.y - draggingPiece.correctY);
      if (dx < snap && dy < snap) {
        draggingPiece.x = draggingPiece.correctX;
        draggingPiece.y = draggingPiece.correctY;
        draggingPiece.placed = true;
        placedCount++;
        soundPlace.currentTime = 0;
        soundPlace.play().catch(() => {});
        // Mover pieza colocada al fondo para no tapar
        const idx = pieces.indexOf(draggingPiece);
        if (idx > -1) {
          pieces.splice(idx, 1);
          pieces.unshift(draggingPiece);
        }
        if (placedCount === pieces.length) {
          onComplete();
        }
      }
      draggingPiece = null;
      draw();
    }

    function onComplete() {
      completeMsg.style.display = "block";
      soundComplete.play().catch(() => {});
      const wrapper = document.getElementById("puzzleWrapper");
      wrapper.style.borderColor = "#4CAF50";
    }

    continueBtn.addEventListener("click", () => {
      completeMsg.style.display = "none";
    });

    restartBtn.addEventListener("click", () => {
      init();
    });

    // Eventos touch y mouse
    canvas.addEventListener("mousedown", startDrag);
    canvas.addEventListener("touchstart", e => {
      e.preventDefault();
      startDrag(e.touches[0]);
    }, { passive: false });

    canvas.addEventListener("mousemove", onDrag);
    canvas.addEventListener("touchmove", e => {
      e.preventDefault();
      onDrag(e.touches[0]);
    }, { passive: false });

    canvas.addEventListener("mouseup", stopDrag);
    canvas.addEventListener("mouseleave", stopDrag);
    canvas.addEventListener("touchend", e => {
      e.preventDefault();
      stopDrag();
    }, { passive: false });

    // Tecla ESC para reiniciar
    window.addEventListener("keydown", e => {
      if (e.key === "Escape") {
        init();
      }
    });
  })();
</script>
</body>
</html>
